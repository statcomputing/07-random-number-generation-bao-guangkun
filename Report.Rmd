---
title: "Assignment 7"
author: "Guangkun Bao"
date: "2020/10/25"
output: html_document
---

```{r setup, include=FALSE}
Sys.setenv(LANG = "en")
knitr::opts_chunk$set(echo = TRUE)
```

## 5.3.1 Rejection sampling

#### Find the value of the normalizing constant for $g$. Show that $g$ is a mixture of Gamma distributions. Identify the component distributions and their weights in the mixture.

Since 

$$\int_{0}^{\infty} (2x^{\theta-1} + x^{\theta-1/2})e^{-x} 
= 2 \Gamma(\theta) + \Gamma(\theta + 1/2)
$$.

Thus, $C = \frac{1}{(2 \Gamma(\theta) + \Gamma(\theta + 1/2))}$

$$
g = 2C \Gamma(\theta)Gamma(\theta,1) + 
C \Gamma(\theta+1/2)Gamma(\theta+1/2,1)
$$

#### Design a procedure (pseudo-code) to sample from $g$; implement it in an R function; draw a sample of size $n = 10,000$ using your function for at least one $\theta$ value; plot the kernel density estimation of $g$ from your sample and the true density in one figure.

```{}
Repeat N times:
1. draw k from categorical distribution parametrized by vector pi,
2. draw single value from k-th gamma distribution parametrized by alpha_k, beta_k.
```

```{r}
# density
dmixgamma <- function(x, pi, alpha, beta) {
  k <- length(pi)
  n <- length(x)
  rowSums(vapply(1:k, function(i) pi[i] * dgamma(x, alpha[i], beta[i]), numeric(n)))
}

# random generation
rmixgamma <- function(n, pi, alpha, beta) {
  k <- sample.int(length(pi), n, replace = TRUE, prob = pi)
  rgamma(n, alpha[k], beta[k])
}
```

```{r}
#simulation
set.seed(123)

theta = 10
C = 1/(2*gamma(theta) + gamma(theta+0.5))
pi <- c(2*gamma(theta)*C, gamma(theta+0.5)*C)
alpha <- c(theta, theta+0.5)
beta <- c(1, 1)

plot(density(rmixgamma(1e5, pi, alpha, beta)),
     main = 'Overlaied Kernel density')
xx <- seq(0, 30, by = 0.0005)
lines(xx, dmixgamma(xx, pi, alpha, beta), col = "red")
```

#### Design a procedure (pseudo-code) to use rejection sampling to sample from $f$ using $g$ as the instrumental distribution. Overlay the estimated kernel density of a random sample generated by your procedure and $f$.

Since $x>0$, for $\alpha \geq 1$

$$
(2x^{\theta-1} + x^{\theta-1/2})e^{-x}
\geq \sqrt{4+x} x^{\theta-1} e^{-x}
$$

```{r}
x = double(1e4)
i = 1
while (x[1e4] == 0) {
  u = runif(1)
  g = rmixgamma(1, pi, alpha, beta)
  q = sqrt(4 + g) * g^(theta-1) * exp(-g)
  if (u <= q/(g/C)) {
    x[i] = g
    i=i+1
  }
}
plot(density(x),
     main = 'Overlaied Kernel density')
xx <- seq(0, 20, by = 0.001)
f = function(g) {sqrt(4 + g) * g^(theta-1) * exp(-g)}
xx = as.numeric(lapply(xx, f))
lines(xx, dmixgamma(xx, pi, alpha, beta), col = "red")
```